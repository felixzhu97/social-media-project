# 购物系统运维手册

本运维手册为系统管理员和开发运维人员提供了购物系统的日常运维指南、问题排查和最佳实践。

## 1. 系统架构概览

购物系统包含以下核心组件：

- **前端应用**：基于Next.js的React应用
- **后端API**：Express.js应用
- **数据库**：MongoDB
- **部署平台**：Vercel
- **监控系统**：Vercel Analytics
- **缓存系统**：Vercel Edge Network, Turborepo

架构图可参考[系统架构文档](./system-architecture.md)。

## 2. 环境管理

### 2.1 环境配置

系统包含以下环境：

| 环境     | 用途                   | 访问地址                         |
| -------- | ---------------------- | -------------------------------- |
| 开发环境 | 日常开发和功能测试     | https://dev.shopping-system.com  |
| 测试环境 | 集成测试和用户验收测试 | https://test.shopping-system.com |
| 生产环境 | 线上服务               | https://shopping-system.com      |

### 2.2 环境变量管理

环境变量配置参考[环境变量配置指南](./ENVIRONMENT.md)。

关键环境变量包括：

- `MONGODB_URI`：MongoDB连接字符串
- `JWT_SECRET`：JWT认证密钥
- `NODE_ENV`：运行环境标识符
- `ADMIN_SECRET`：管理员认证密钥

各环境的环境变量在Vercel平台上管理。确保在添加或修改环境变量后重新部署应用。

## 3. 日常维护任务

### 3.1 定期备份

#### 数据库备份

MongoDB Atlas提供自动备份功能，配置如下：

1. 访问Atlas控制台 → 选择集群 → Backup
2. 当前配置：每日备份，保留期7天

手动备份命令：

```bash
# 使用mongodump工具备份
mongodump --uri="mongodb+srv://<username>:<password>@<cluster>.mongodb.net/<database>" --out=/backup/$(date +%Y-%m-%d)

# 压缩备份文件
tar -zcvf /backup/$(date +%Y-%m-%d).tar.gz /backup/$(date +%Y-%m-%d)
```

### 3.2 监控系统健康状态

#### 系统监控检查清单

每日监控检查项目：

- [ ] Vercel控制台检查部署状态
- [ ] MongoDB Atlas控制台检查数据库状态
- [ ] 检查API响应时间和错误率
- [ ] 检查前端性能指标
- [ ] 检查系统日志中的错误

### 3.3 性能优化

#### 定期性能审查

每月执行以下性能审查：

1. 前端性能审查

   - 使用Lighthouse分析页面性能
   - 分析Vercel Analytics数据

2. 数据库性能审查

   - 检查慢查询日志
   - 优化索引
   - 分析数据库连接数和查询性能

3. API性能审查
   - 分析API响应时间
   - 检查高频API调用的缓存策略

## 4. 故障处理

### 4.1 常见问题诊断

#### 前端问题

| 问题         | 可能原因                    | 解决方案                                        |
| ------------ | --------------------------- | ----------------------------------------------- |
| 页面加载缓慢 | 资源体积过大、缓存失效      | 分析页面加载瀑布图，优化资源，检查缓存配置      |
| 白屏错误     | JavaScript错误、API响应失败 | 检查浏览器控制台错误日志，修复前端代码或API问题 |
| 样式错乱     | CSS冲突、响应式设计问题     | 检查最近CSS变更，调整样式规则                   |

#### 后端问题

| 问题        | 可能原因                   | 解决方案                                    |
| ----------- | -------------------------- | ------------------------------------------- |
| API响应错误 | 服务器错误、数据库连接问题 | 检查服务器日志，重启API服务，验证数据库连接 |
| 认证失败    | JWT密钥配置错误、令牌过期  | 检查JWT配置，清除过期令牌                   |
| 性能下降    | 数据库查询效率低、资源不足 | 优化数据库查询，增加资源配置                |

#### 数据库问题

| 问题         | 可能原因             | 解决方案                                   |
| ------------ | -------------------- | ------------------------------------------ |
| 连接超时     | 网络问题、连接数耗尽 | 检查网络配置，优化连接池，增加最大连接数   |
| 查询缓慢     | 缺少索引、查询未优化 | 添加适当索引，重写低效查询                 |
| 磁盘空间不足 | 数据量增长、日志积累 | 清理不必要的数据，归档旧数据，调整存储配置 |

### 4.2 紧急服务恢复程序

在发生严重故障需要恢复服务时，执行以下步骤：

1. **评估影响**：确定故障影响范围和严重程度
2. **通知团队**：通过紧急联系渠道通知相关团队成员
3. **临时措施**：如果可能，实施临时解决方案恢复核心功能
4. **回滚部署**：必要时回滚到最近稳定版本

#### 回滚到上一版本

```bash
# 使用Vercel CLI回滚到上一个部署
vercel rollback --scope=your-team-name
```

### 4.3 事故报告和复盘

服务故障后，创建详细的事故报告，包括：

1. 事故摘要和时间线
2. 根本原因分析
3. 影响评估
4. 解决过程
5. 预防措施
6. 后续行动

## 5. 安全维护

### 5.1 安全更新

定期执行以下安全维护任务：

1. 依赖项更新

```bash
# 检查依赖更新
pnpm outdated

# 更新依赖
pnpm update
```

2. 系统补丁安装
   - 监控MongoDB和Node.js安全公告
   - 及时更新到安全版本

### 5.2 安全审计

季度安全审计：

- [ ] 代码安全扫描（使用Snyk或SonarQube）
- [ ] API安全测试
- [ ] 密码策略和认证机制审查
- [ ] 数据加密审查
- [ ] 访问权限审查

### 5.3 用户权限管理

管理员可通过以下方式管理用户权限：

1. 访问管理后台（/admin/users）
2. 查看/修改用户角色
3. 重置用户密码
4. 禁用/启用用户账户

## 6. 扩展和迁移

### 6.1 系统扩展

当需要扩展系统容量时：

1. **MongoDB扩展**：在MongoDB Atlas升级集群规格
2. **API服务扩展**：调整Vercel计划，增加计算资源
3. **前端性能扩展**：优化前端代码，增加CDN覆盖

### 6.2 数据迁移

执行数据迁移的标准流程：

1. 备份源数据库
2. 创建迁移计划和回滚计划
3. 在测试环境验证迁移脚本
4. 安排维护窗口，通知用户
5. 执行迁移，监控进度
6. 验证迁移结果
7. 恢复服务，监控性能

## 7. 监控与报警

### 7.1 监控系统

系统使用以下监控工具：

1. **Vercel监控**：监控应用性能和部署状态
2. **MongoDB Atlas监控**：监控数据库性能和健康状态
3. **自定义健康检查**：通过API端点(/api/health)监控系统状态

### 7.2 报警配置

报警通过以下渠道发送：

1. 电子邮件通知（主要团队成员）
2. Slack通知（运维频道）
3. SMS通知（严重问题）

报警触发条件：

- API错误率 > 1%
- API响应时间 > 1000ms
- 数据库连接失败
- 磁盘使用率 > 80%
- CPU使用率 > 90%持续5分钟

## 8. 容量规划

### 8.1 资源需求评估

当前系统资源配置：

- **MongoDB Atlas**：M10集群（2GB RAM, 10GB存储）
- **Vercel**：Pro计划
- **估计容量**：支持10,000注册用户，日活跃用户1,000

扩展标准：当达到以下阈值时考虑升级：

- 数据库利用率 > 70%
- API响应时间增加 > 20%
- 并发用户数 > 500

### 8.2 容量管理

监控以下指标进行容量管理：

1. 数据库大小增长率
2. API调用频率趋势
3. 用户增长率
4. 订单处理量

## 9. 日志管理

### 9.1 日志收集

系统日志收集配置：

1. **应用日志**：存储在Vercel日志系统
2. **数据库日志**：MongoDB Atlas日志
3. **审计日志**：记录关键操作，存储在专用日志集合

### 9.2 日志查询

查看最近应用日志：

```bash
# 使用Vercel CLI查看日志
vercel logs shopping-system

# 筛选错误日志
vercel logs shopping-system --since 2h --scope=your-team-name | grep ERROR
```

### 9.3 日志保留策略

- 应用日志：保留30天
- 数据库日志：保留7天
- 审计日志：保留1年

## 10. 文档维护

### 10.1 文档更新

运维文档应在以下情况下更新：

1. 系统架构变更
2. 运维流程改变
3. 新增监控或报警配置
4. 解决问题后发现新的故障处理流程

### 10.2 知识管理

团队使用以下工具进行知识分享：

1. GitHub Wiki：技术文档
2. Notion：运维指南和故障处理经验
3. Slack：日常沟通和知识分享

## 11. 联系信息

### 11.1 技术支持团队

| 角色           | 负责人 | 联系方式                     | 工作时间   |
| -------------- | ------ | ---------------------------- | ---------- |
| 系统管理员     | 张三   | admin@shopping-system.com    | 9:00-18:00 |
| 数据库管理员   | 李四   | dba@shopping-system.com      | 9:00-18:00 |
| 前端开发负责人 | 王五   | frontend@shopping-system.com | 9:00-18:00 |
| 后端开发负责人 | 赵六   | backend@shopping-system.com  | 9:00-18:00 |

### 11.2 紧急联系流程

工作时间紧急问题联系方式：

1. Slack @oncall频道
2. 电话联系当值工程师

非工作时间紧急问题：

1. 拨打紧急电话：+86-123-4567890
2. 发送短信到：+86-123-4567890
3. 电子邮件：emergency@shopping-system.com
